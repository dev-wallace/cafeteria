<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
  <meta charset="UTF-8">
  <title>Fragment Header - Cafeteria</title>
  
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    .navbar-custom{
      background: linear-gradient(180deg, #00704A, #00653e);
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
      box-shadow: 0 6px 18px rgba(3, 31, 22, 0.18);
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #ffffff !important;
      font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      letter-spacing: 0.2px;
    }

    .brand-badge {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: rgba(255,255,255,0.12);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      color: #e9f6f2;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }

    /* Search */
    .nav-search {
      min-width: 260px;
      max-width: 420px;
    }
    .nav-search .form-control {
      border-radius: 999px 0 0 999px;
      border: 2px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: #ffffff;
      transition: box-shadow .18s, background .18s;
      padding-left: 14px;
    }
    .nav-search .form-control::placeholder { color: rgba(255,255,255,0.7); }
    .nav-search .btn {
      border-radius: 0 999px 999px 0;
      background: rgba(255,255,255,0.12);
      color: #ffffff;
      border: 2px solid rgba(255,255,255,0.12);
    }
    .nav-search .form-control:focus {
      background: rgba(255,255,255,0.12);
      box-shadow: 0 4px 18px rgba(0,0,0,0.18);
    }

    /* Links */
    .nav-link {
      color: rgba(255,255,255,0.95) !important;
      margin-right: 4px;
      transition: color .15s, transform .12s;
    }
    .nav-link:hover { color: #20c997 !important; transform: translateY(-2px); }

    /* Cart badge */
    .cart-btn {
      position: relative;
      display: inline-flex;
      align-items:center;
      gap: 8px;
      color: #ffffff;
    }
    .cart-count {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: 999px;
      background: #20c997;
      color: #062918;
      font-weight: 700;
      font-size: 12px;
      display: none;
      align-items: center;
      justify-content: center;
    }

    /* Small screens adjustments */
    @media (max-width: 768px){
      .nav-search { display: none; }
      .brand-badge { width:36px; height:36px; font-size:16px; }
    }

    /* Smooth toggler color */
    .navbar .navbar-toggler {
      border-color: rgba(255,255,255,0.12);
    }
    .navbar .navbar-toggler-icon { filter: invert(1) brightness(1.8) contrast(.9); }

    /* Profile dropdown style */
    .dropdown-menu {
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(3,31,22,0.18);
      border: none;
      background: linear-gradient(180deg, #ffffff, #f7fbf9);
    }
    .dropdown-item:hover { background: rgba(0,0,0,0.04); }
  </style>
</head>
<body>
  <header th:fragment="header">
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom py-2">
      <div class="container">
        <!-- Logo -->
        <a class="navbar-brand" th:href="@{/}">
          <span class="brand-badge"><i class="bi bi-cup-hot"></i></span>
          <span class="d-none d-md-inline">Cafeteria</span>
          <small class="text-muted d-inline d-md-none" style="opacity:.95">Café</small>
        </a>

        <!-- Toggler -->
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain"
                aria-controls="navMain" aria-expanded="false" aria-label="Alternar menu">
          <span class="navbar-toggler-icon"></span>
        </button>

        <!-- Menu -->
        <div class="collapse navbar-collapse" id="navMain">
          <ul class="navbar-nav ms-auto align-items-center gap-2">
            <li class="nav-item d-none d-md-flex me-2 nav-search">
              <div class="input-group">
                <input class="form-control" id="site-search" type="search" placeholder="Buscar produto..." aria-label="Buscar">
                <button class="btn" id="btn-search" type="button"><i class="bi bi-search"></i></button>
              </div>
            </li>

            <li class="nav-item">
              <a class="nav-link" th:href="@{/menu}"><i class="bi bi-list"></i> Cardápio</a>
            </li>

            <!-- Apenas para usuários autenticados -->
            <span sec:authorize="isAuthenticated()">
              <span sec:authorize="hasAuthority('ROLE_CLIENTE')">
                <li class="nav-item">
                  <a class="nav-link cart-btn" th:href="@{/carrinho}">
                    <i class="bi bi-cart4"></i>
                    <span class="d-none d-md-inline">Carrinho</span>
                    <span id="cart-count" class="cart-count" aria-live="polite">0</span>
                  </a>
                </li>
                <li class="nav-item dropdown">
                  <a class="nav-link dropdown-toggle" href="#" id="userMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-person-circle"></i> <span class="d-none d-md-inline">Meu Perfil</span>
                  </a>
                  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
                    <li><a class="dropdown-item" th:href="@{/perfil}">Perfil</a></li>
                    <li><a class="dropdown-item" th:href="@{/pedidos}">Pedidos</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" th:href="@{/logout}"><i class="bi bi-box-arrow-right"></i> Sair</a></li>
                  </ul>
                </li>
              </span>

              <span sec:authorize="hasAuthority('ROLE_FUNCIONARIO')">
                <li class="nav-item">
                  <a class="nav-link" th:href="@{/admin/dashboard}"><i class="bi bi-gear-fill"></i> Admin</a>
                </li>
              </span>
            </span>

            <!-- Se não autenticado -->
            <span sec:authorize="!isAuthenticated()">
              <li class="nav-item">
                <a class="nav-link" th:href="@{/login}"><i class="bi bi-shield-lock"></i> Login</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" th:href="@{/cadastro}"><i class="bi bi-pencil-square"></i> Cadastro</a>
              </li>
            </span>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Script pequeno para atualizar badge do carrinho -->
    <script>
      document.addEventListener('DOMContentLoaded', function(){
        function updateCartCount(){
          try{
            const cart = JSON.parse(localStorage.getItem('carrinho') || '{}');
            const count = Object.values(cart).reduce((s, v) => s + (Number(v) || 0), 0);
            const badge = document.getElementById('cart-count');
            if(!badge) return;
            badge.textContent = count;
            badge.style.display = (count > 0) ? 'inline-flex' : 'none';
          }catch(e){
            // fail silently
          }
        }

        // Buscar botão de busca apenas visual (pode integrar com backend)
        const btnSearch = document.getElementById('btn-search');
        const input = document.getElementById('site-search');
        if(btnSearch && input){
          btnSearch.addEventListener('click', () => {
            const q = input.value.trim();
            if(!q) return;
            // exemplo: redireciona para /menu?search=...
            window.location.href = `/menu?search=${encodeURIComponent(q)}`;
          });
          input.addEventListener('keypress', (e) => { if(e.key === 'Enter') btnSearch.click(); });
        }

        updateCartCount();
        // opcional: observe mudanças no localStorage (ou chamar updateCartCount após adicionar)
        window.addEventListener('storage', updateCartCount);
      });
    </script>
  </header>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>